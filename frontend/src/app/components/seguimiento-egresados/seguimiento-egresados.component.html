<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- âœ… HEADER -->
<div class="bg-white border-y mt-10 py-5 shadow-lg">
  <div class="flex items-center justify-between w-11/12">
    <button
      pButton
      type="button"
      icon="pi pi-arrow-left"
      label="Volver"
      class="p-button-outlined p-button-secondary rounded-full shadow-sm px-4 py-2"
      (click)="volverMenu()"
    ></button>

    <div class="bg-sky-700 w-6/12 rounded-r-xl py-4">
      <h1 class="text-3xl text-white text-center font-bold">
        Seguimiento de Egresados
      </h1>
    </div>
  </div>
</div>

<!-- ==========================================================
âœ… EGRESADO: FORMULARIO EN PANTALLA PRINCIPAL
========================================================== -->
<div class="m-10 bg-white p-8 shadow-lg rounded-md" *ngIf="isEgresado">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-sky-700">
      ðŸ“„ Formulario Seguimiento Egresados
    </h2>
  </div>

  <div id="formulario-egresados" class="bg-white p-2">
    <ng-container *ngTemplateOutlet="formularioTemplate"></ng-container>
  </div>
</div>

<!-- ==========================================================
âœ… OTROS ROLES: SIDEBAR/DRAWER COMO ANTES
========================================================== -->
<p-sidebar
  *ngIf="!isEgresado"
  [(visible)]="drawerFormulario"
  position="right"
  [baseZIndex]="10000"
  [style]="{ width: '720px' }"
  [modal]="true"
>
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-sky-700">
      ðŸ“„ Formulario Seguimiento Egresados
    </h2>

    <button
      pButton
      type="button"
      icon="pi pi-times"
      class="p-button-rounded p-button-text p-button-danger"
      (click)="cerrarDrawerFormulario()"
      pTooltip="Cerrar"
    ></button>
  </div>

  <div id="formulario-egresados" class="bg-white p-2">
    <ng-container *ngTemplateOutlet="formularioTemplate"></ng-container>
  </div>
</p-sidebar>

<!-- ==========================================================
âœ… TEMPLATE ÃšNICO: FORMULARIO (ES TU MISMO FORMULARIO)
========================================================== -->
<ng-template #formularioTemplate>
  <form [formGroup]="formulario" class="grid grid-cols-2 gap-6">
    <div class="col-span-2">
      <h2 class="text-xl font-bold text-sky-700">InformaciÃ³n General</h2>
      <hr class="my-3" />
    </div>

    <!-- âœ… NUEVO: si es EGRESADO, ocultar botones de modo -->
    <div class="col-span-2 flex gap-4 items-center mb-2" *ngIf="!isEgresado">
      <label class="font-semibold">Modo:</label>

      <button
        pButton
        type="button"
        class="p-button-sm"
        [class.p-button-info]="modoEstudiante === 'existente'"
        [class.p-button-outlined]="modoEstudiante !== 'existente'"
        (click)="modoEstudiante = 'existente'"
      >
        Seleccionar Estudiante
      </button>

      <button
        pButton
        type="button"
        class="p-button-sm"
        [class.p-button-success]="modoEstudiante === 'nuevo'"
        [class.p-button-outlined]="modoEstudiante !== 'nuevo'"
        (click)="cambiarAModoNuevo()"
      >
        Crear Estudiante Nuevo
      </button>
    </div>

    <!-- âœ… EXISTENTE: seleccionar estudiante -->
    <div class="col-span-2" *ngIf="!isEgresado && modoEstudiante === 'existente'">
      <label class="block font-semibold mb-2">Seleccionar Estudiante *</label>

      <p-dropdown
        [options]="estudiantes"
        [(ngModel)]="estudianteSeleccionado"
        [ngModelOptions]="{ standalone: true }"
        optionLabel="nombreCompleto"
        dataKey="idEstudiante"
        placeholder="Buscar por nombre o rut"
        [filter]="true"
        filterBy="nombreCompleto,rut"
        [showClear]="true"
        class="w-full"
        (onChange)="onEstudianteChange()"
      >
        <ng-template let-estudiante pTemplate="item">
          <div class="flex flex-col">
            <span class="font-bold">{{ estudiante.nombreCompleto }}</span>
            <small class="text-gray-500">{{ estudiante.rut }}</small>
          </div>
        </ng-template>
      </p-dropdown>

      <small class="text-red-500" *ngIf="intentoGuardar && !estudianteSeleccionado">
        Debes seleccionar un estudiante.
      </small>
    </div>

    <!-- âœ… EXISTENTE: RUT (con DV, sin validaciÃ³n) -->
    <div
      class="col-span-2"
      *ngIf="!isEgresado && modoEstudiante === 'existente' && estudianteSeleccionado"
    >
      <label class="block font-semibold mb-2">RUT (con DV) *</label>
      <input
        pInputText
        [(ngModel)]="estudianteSeleccionado.rut"
        [ngModelOptions]="{ standalone: true }"
        placeholder="Ej: 10.000.196-9"
        class="w-full"
        maxlength="12"
        inputmode="text"
        autocomplete="off"
        (input)="onRutInputExistente()"
      />

      <!-- âœ… desactivado: no validar rut real/falso -->
      <small class="text-red-500" *ngIf="false">
        RUT invÃ¡lido.
      </small>
    </div>

    <!-- âœ… EXISTENTE: Plan (info readonly) -->
    <div class="col-span-2" *ngIf="modoEstudiante === 'existente' && estudianteSeleccionado">
      <label class="block font-semibold mb-2">Plan actual (info)</label>
      <input
        pInputText
        formControlName="planEstudios"
        class="w-full"
        placeholder="Se cargarÃ¡ automÃ¡ticamente"
        readonly
      />
      <small class="text-gray-500">
        Este campo es informativo (viene del seguimiento/plan actual).
      </small>
    </div>

    <!-- âœ…âœ…âœ… EXISTENTE: Plan editable -->
    <div class="col-span-2" *ngIf="modoEstudiante === 'existente' && estudianteSeleccionado">
      <label class="block font-semibold mb-2">Plan de estudios (editable) *</label>

      <p-dropdown
        [options]="planesOptions"
        [(ngModel)]="planSeleccionadoId"
        [ngModelOptions]="{ standalone: true }"
        placeholder="Selecciona un plan"
        [filter]="true"
        filterBy="label"
        [showClear]="true"
        class="w-full"
      ></p-dropdown>

      <small
        class="text-xs text-gray-500"
        *ngIf="planOriginalId && planSeleccionadoId && planSeleccionadoId !== planOriginalId"
      >
        ðŸ“Œ CambiarÃ¡s el plan en la BD del estudiante al guardar.
      </small>

      <small class="text-red-500" *ngIf="intentoGuardar && !planSeleccionadoId">
        Debes seleccionar un plan.
      </small>
    </div>

    <!-- âœ… NUEVO: crear estudiante -->
    <div class="col-span-2" *ngIf="!isEgresado && modoEstudiante === 'nuevo'">
      <h3 class="text-lg font-bold text-sky-700 mt-2">ðŸ†• Nuevo Estudiante</h3>

      <div class="grid grid-cols-2 gap-6 mt-4">
        <div>
          <label class="block font-semibold mb-2">RUT (con DV) *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.rut"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: 10.000.196-9"
            class="w-full"
            maxlength="12"
            inputmode="text"
            autocomplete="off"
            (input)="onRutInputNuevo()"
          />

          <!-- âœ… desactivado: no validar rut real/falso -->
          <small class="text-red-500" *ngIf="false">
            RUT invÃ¡lido.
          </small>
        </div>

        <div>
          <label class="block font-semibold mb-2">AÃ±o ingreso *</label>
          <p-inputNumber
            [(ngModel)]="nuevoEstudiante.agnioIngreso"
            [ngModelOptions]="{ standalone: true }"
            class="w-full"
            [useGrouping]="false"
          ></p-inputNumber>
        </div>

        <div>
          <label class="block font-semibold mb-2">Nombre *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.nombre"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: Juan"
            class="w-full"
          />
        </div>

        <div>
          <label class="block font-semibold mb-2">Plan de Estudios *</label>

          <p-dropdown
            [options]="planesOptions"
            [(ngModel)]="nuevoEstudiante.idPlan"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Selecciona un plan"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
            class="w-full"
          ></p-dropdown>

          <small class="text-red-500" *ngIf="intentoGuardar && !nuevoEstudiante.idPlan">
            Debes seleccionar un plan.
          </small>
        </div>

        <div class="col-span-2">
          <label class="block font-semibold mb-2">Apellido *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.apellido"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: PÃ©rez"
            class="w-full"
          />
        </div>
      </div>
    </div>

    <!-- ======= TODO EL RESTO DE TU FORMULARIO QUEDA IGUAL ======= -->

    <!-- âœ… Seguimiento (ENCUESTA: solo aÃ±o fin estudios) -->
    <div>
      <label class="block font-semibold mb-2">AÃ±o fin de estudios *</label>
      <p-inputNumber
        formControlName="anioFinEstudios"
        class="w-full"
        [useGrouping]="false"
        placeholder="Ej: 2024"
      ></p-inputNumber>

      <small class="text-red-500" *ngIf="isInvalid('anioFinEstudios')">
        <ng-container *ngIf="getError('anioFinEstudios')?.required">
          Debes indicar el aÃ±o de finalizaciÃ³n.
        </ng-container>
        <ng-container *ngIf="getError('anioFinEstudios')?.min">AÃ±o demasiado bajo.</ng-container>
        <ng-container *ngIf="getError('anioFinEstudios')?.max">AÃ±o demasiado alto.</ng-container>
      </small>
    </div>

    <div>
      <label class="block font-semibold mb-2">SituaciÃ³n Actual *</label>
      <p-dropdown
        formControlName="situacionActual"
        [options]="situaciones"
        placeholder="Seleccionar"
        class="w-full"
      ></p-dropdown>
    </div>

    <div class="col-span-2" *ngIf="formulario.get('situacionActual')?.value === 'Otro'">
      <label class="block font-semibold mb-2">Especifica (Otro) *</label>
      <input
        pInputText
        formControlName="situacionActualOtro"
        class="w-full"
        placeholder="Ej: emprendimiento, licencia, etc."
      />
      <small class="text-red-500" *ngIf="formHasError('situacionActualOtroRequerido')">
        Debes especificar la situaciÃ³n.
      </small>
    </div>

    <div>
      <label class="block font-semibold mb-2">Empresa</label>
      <input pInputText formControlName="empresa" class="w-full" />
    </div>

    <div>
      <label class="block font-semibold mb-2">Cargo</label>
      <input pInputText formControlName="cargo" class="w-full" />
    </div>

    <!-- ... (tu resto de formulario igual) ... -->

    <div class="col-span-2 flex justify-end gap-4 mt-8">
      <button pButton type="button" class="p-button-warning" (click)="resetFormulario()">
        Limpiar
      </button>

      <button pButton type="button" class="p-button-success" (click)="guardar()">
        Guardar
      </button>
    </div>
  </form>
</ng-template>

<!-- ==========================================================
âœ… DASHBOARD SUBCOMPONENTE (solo no egresado)
========================================================== -->
<app-egresados-dashboard
  *ngIf="!isEgresado"
  [isEgresado]="isEgresado"
  [egresados]="egresados"
  [loading]="loading"
  [stats]="stats"
  [donutOptions]="donutOptions"
  [donutSituacionData]="donutSituacionData"
  [donutDocsData]="donutDocsData"
  [donutAnioData]="donutAnioData"
  [cohortesOptions]="cohortesOptions"
  [cohorteSeleccionada]="cohorteSeleccionada"
  [kpiCohorte]="kpiCohorte"
  [chartOptionsCohorte]="chartOptionsCohorte"
  [barSituacionCohorteData]="barSituacionCohorteData"
  [donutRentasCohorteData]="donutRentasCohorteData"
  [filtrosConfig]="filtrosConfig"
  [filtroValores]="filtroValores"
  (filtroValoresChange)="filtroValores = $event"
  [modalFiltrosVisible]="modalFiltrosVisible"
  (modalFiltrosVisibleChange)="modalFiltrosVisible = $event"
  [modalDocsVisible]="modalDocsVisible"
  [documentosModal]="documentosModal"
  (cerrarModalDocumentos)="modalDocsVisible = false"
  [getDropdownOptions]="getDropdownOptions.bind(this)"
  (abrirFormularioNuevo)="abrirFormularioNuevo()"
  (abrirEdicion)="abrirEdicion($event)"
  (eliminar)="eliminar($event)"
  (abrirModalDocumentos)="abrirModalDocumentos($event)"
  (onCohorteChange)="onCohorteChange()"
  (verDocumento)="verDocumento($event)"
  (descargarDocumento)="descargarDocumento($event)"
  (eliminarDocumento)="eliminarDocumento($event)"
/>
