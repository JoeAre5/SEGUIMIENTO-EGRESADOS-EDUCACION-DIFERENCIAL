<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- ‚úÖ HEADER -->
<div class="bg-white border-y mt-10 py-5 shadow-lg">
  <div class="flex items-center justify-between w-11/12">
    <button
      pButton
      type="button"
      icon="pi pi-arrow-left"
      label="Volver"
      class="p-button-outlined p-button-secondary rounded-full shadow-sm px-4 py-2"
      (click)="volverMenu()"
    ></button>

    <div class="bg-sky-700 w-6/12 rounded-r-xl py-4">
      <h1 class="text-3xl text-white text-center font-bold">
        Seguimiento de Egresados
      </h1>
    </div>
  </div>
</div>

<!-- ‚úÖ DRAWER / SIDEBAR FORMULARIO -->
<p-sidebar
  [(visible)]="drawerFormulario"
  position="right"
  [baseZIndex]="10000"
  [style]="{ width: '720px' }"
  [modal]="true"
>
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-sky-700">
      üìÑ Formulario Seguimiento Egresados
    </h2>

    <button
      pButton
      type="button"
      icon="pi pi-times"
      class="p-button-rounded p-button-text p-button-danger"
      (click)="cerrarDrawerFormulario()"
      pTooltip="Cerrar"
    ></button>
  </div>

  <div id="formulario-egresados" class="bg-white p-2">
    <form [formGroup]="formulario" class="grid grid-cols-2 gap-6">
      <div class="col-span-2">
        <h2 class="text-xl font-bold text-sky-700">Informaci√≥n General</h2>
        <hr class="my-3" />
      </div>

      <div class="col-span-2 flex gap-4 items-center mb-2">
        <label class="font-semibold">Modo:</label>

        <button
          pButton
          type="button"
          class="p-button-sm"
          [class.p-button-info]="modoEstudiante === 'existente'"
          [class.p-button-outlined]="modoEstudiante !== 'existente'"
          (click)="modoEstudiante = 'existente'"
        >
          Seleccionar Estudiante
        </button>

        <button
          pButton
          type="button"
          class="p-button-sm"
          [class.p-button-success]="modoEstudiante === 'nuevo'"
          [class.p-button-outlined]="modoEstudiante !== 'nuevo'"
          (click)="cambiarAModoNuevo()"
        >
          Crear Estudiante Nuevo
        </button>
      </div>

      <div class="col-span-2" *ngIf="modoEstudiante === 'existente'">
        <label class="block font-semibold mb-2">Seleccionar Estudiante *</label>

        <p-dropdown
          [options]="estudiantes"
          [(ngModel)]="estudianteSeleccionado"
          [ngModelOptions]="{ standalone: true }"
          optionLabel="nombreCompleto"
          dataKey="idEstudiante"
          placeholder="Buscar por nombre o rut"
          [filter]="true"
          filterBy="nombreCompleto,rut"
          [showClear]="true"
          class="w-full"
          (onChange)="onEstudianteChange()"
        >
          <ng-template let-estudiante pTemplate="item">
            <div class="flex flex-col">
              <span class="font-bold">{{ estudiante.nombreCompleto }}</span>
              <small class="text-gray-500">{{ estudiante.rut }}</small>
            </div>
          </ng-template>
        </p-dropdown>

        <small
          class="text-red-500"
          *ngIf="intentoGuardar && !estudianteSeleccionado"
        >
          Debes seleccionar un estudiante.
        </small>
      </div>

      <div
        class="col-span-2"
        *ngIf="modoEstudiante === 'existente' && estudianteSeleccionado"
      >
        <label class="block font-semibold mb-2">RUT *</label>
        <input
          pInputText
          [(ngModel)]="estudianteSeleccionado.rut"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Ej: 20.123.456-7"
          class="w-full"
          maxlength="12"
          inputmode="text"
          autocomplete="off"
          (input)="onRutInputExistente()"
        />

        <small
          class="text-red-500"
          *ngIf="
            intentoGuardar &&
            !isRutValido((estudianteSeleccionado?.rut || ''))
          "
        >
          RUT inv√°lido. Revisa el d√≠gito verificador.
        </small>
      </div>

      <div class="col-span-2" *ngIf="modoEstudiante === 'nuevo'">
        <h3 class="text-lg font-bold text-sky-700 mt-2">
          üÜï Nuevo Estudiante
        </h3>

        <div class="grid grid-cols-2 gap-6 mt-4">
          <div>
            <label class="block font-semibold mb-2">RUT *</label>
            <input
              pInputText
              [(ngModel)]="nuevoEstudiante.rut"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Ej: 20.123.456-7"
              class="w-full"
              maxlength="12"
              inputmode="text"
              autocomplete="off"
              (input)="onRutInputNuevo()"
            />

            <small
              class="text-red-500"
              *ngIf="intentoGuardar && !isRutValido((nuevoEstudiante?.rut || ''))"
            >
              RUT inv√°lido. Revisa el d√≠gito verificador.
            </small>
          </div>

          <div>
            <label class="block font-semibold mb-2">A√±o ingreso *</label>
            <p-inputNumber
              [(ngModel)]="nuevoEstudiante.agnioIngreso"
              [ngModelOptions]="{ standalone: true }"
              class="w-full"
              [useGrouping]="false"
            ></p-inputNumber>
          </div>

          <div>
            <label class="block font-semibold mb-2">Nombre *</label>
            <input
              pInputText
              [(ngModel)]="nuevoEstudiante.nombre"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Ej: Juan"
              class="w-full"
            />
          </div>

          <div>
            <label class="block font-semibold mb-2">Plan de Estudios *</label>

            <p-dropdown
              [options]="planesOptions"
              [(ngModel)]="nuevoEstudiante.idPlan"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Selecciona un plan"
              [filter]="true"
              filterBy="label"
              [showClear]="true"
              class="w-full"
            ></p-dropdown>
          </div>

          <div class="col-span-2">
            <label class="block font-semibold mb-2">Apellido *</label>
            <input
              pInputText
              [(ngModel)]="nuevoEstudiante.apellido"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Ej: P√©rez"
              class="w-full"
            />
          </div>
        </div>
      </div>

      <div>
        <label class="block font-semibold mb-2">Fecha de Egreso *</label>
        <p-calendar
          formControlName="fechaEgreso"
          [showIcon]="true"
          dateFormat="yy-mm-dd"
          class="w-full"
        ></p-calendar>

        <small
          class="text-red-500"
          *ngIf="formHasError('anioSeguimientoMenorQueEgreso')"
        >
          A√±o de seguimiento no puede ser menor que el a√±o de egreso.
        </small>
      </div>

      <div>
        <label class="block font-semibold mb-2">Situaci√≥n Actual *</label>
        <p-dropdown
          formControlName="situacionActual"
          [options]="situaciones"
          placeholder="Seleccionar"
          class="w-full"
        ></p-dropdown>
      </div>

      <div>
        <label class="block font-semibold mb-2">Empresa</label>
        <input pInputText formControlName="empresa" class="w-full" />
      </div>

      <div>
        <label class="block font-semibold mb-2">Cargo</label>
        <input pInputText formControlName="cargo" class="w-full" />
      </div>

      <div>
        <label class="block font-semibold mb-2">Sueldo (CLP)</label>
        <p-inputNumber formControlName="sueldo" class="w-full"></p-inputNumber>
      </div>

      <div>
        <label class="block font-semibold mb-2">A√±o Ingreso Laboral</label>
        <p-inputNumber
          formControlName="anioIngresoLaboral"
          class="w-full"
          [useGrouping]="false"
          placeholder="Ej: 2024"
        ></p-inputNumber>

        <small class="text-red-500" *ngIf="isInvalid('anioIngresoLaboral')">
          <ng-container *ngIf="getError('anioIngresoLaboral')?.min">
            A√±o ingreso laboral demasiado bajo.
          </ng-container>
          <ng-container *ngIf="getError('anioIngresoLaboral')?.max">
            A√±o ingreso laboral demasiado alto.
          </ng-container>
        </small>

        <small
          class="text-red-500"
          *ngIf="formHasError('anioIngresoLaboralMenorQueEgreso')"
        >
          A√±o ingreso laboral debe ser mayor o igual al a√±o de egreso.
        </small>
      </div>

      <div>
        <label class="block font-semibold mb-2">A√±o Seguimiento *</label>
        <p-inputNumber
          formControlName="anioSeguimiento"
          class="w-full"
          [useGrouping]="false"
        ></p-inputNumber>
      </div>

      <div class="col-span-2 mt-6">
        <h2 class="text-xl font-bold text-sky-700">Datos de Contacto</h2>
        <hr class="my-3" />
      </div>

      <div>
        <label class="block font-semibold mb-2">Tel√©fono</label>
        <input
          pInputText
          formControlName="telefono"
          class="w-full"
          placeholder="Ej: +56 12345678 o 12345678"
          (input)="onTelefonoInput()"
        />

        <small class="text-red-500" *ngIf="isInvalid('telefono')">
          <ng-container *ngIf="getError('telefono')?.pattern">
            Tel√©fono inv√°lido. Debe tener 8 d√≠gitos (y c√≥digo pa√≠s opcional). Ej:
            +56 12345678 o 12345678
          </ng-container>
          <ng-container *ngIf="getError('telefono')?.maxlength">
            Tel√©fono demasiado largo.
          </ng-container>
        </small>
      </div>

      <div>
        <label class="block font-semibold mb-2">Correo</label>
        <input pInputText formControlName="emailContacto" class="w-full" />

        <small class="text-red-500" *ngIf="isInvalid('emailContacto')">
          <ng-container *ngIf="getError('emailContacto')?.pattern">
            Correo inv√°lido. Ej: nombre&#64;dominio.cl
          </ng-container>
          <ng-container *ngIf="getError('emailContacto')?.maxlength">
            Correo demasiado largo.
          </ng-container>
        </small>
      </div>

      <div class="col-span-2">
        <label class="block font-semibold mb-2">LinkedIn</label>
        <input
          pInputText
          formControlName="linkedin"
          class="w-full"
          placeholder="https://www.linkedin.com/in/..."
        />

        <small class="text-red-500" *ngIf="isInvalid('linkedin')">
          <ng-container *ngIf="getError('linkedin')?.pattern">
            URL de LinkedIn inv√°lida. Ej: https://www.linkedin.com/in/usuario
          </ng-container>
          <ng-container *ngIf="getError('linkedin')?.maxlength">
            URL demasiado larga.
          </ng-container>
        </small>
      </div>

      <div class="col-span-2">
        <label class="block font-semibold mb-2">Direcci√≥n</label>
        <input pInputText formControlName="direccion" class="w-full" />

        <small
          class="text-red-500"
          *ngIf="isInvalid('direccion') && getError('direccion')?.maxlength"
        >
          Direcci√≥n demasiado larga.
        </small>
      </div>

      <div class="col-span-2">
        <label class="block font-semibold mb-2">Contacto Alternativo</label>
        <input pInputText formControlName="contactoAlternativo" class="w-full" />

        <small
          class="text-red-500"
          *ngIf="
            isInvalid('contactoAlternativo') &&
            getError('contactoAlternativo')?.maxlength
          "
        >
          Texto demasiado largo.
        </small>
      </div>

      <div class="col-span-2 mt-6">
        <h2 class="text-xl font-bold text-sky-700">Documentos</h2>
        <hr class="my-3" />
      </div>

      <div class="col-span-2 mt-2" *ngIf="documentosExistentes.length > 0">
        <h3 class="text-lg font-bold text-sky-700 mb-2">
          üìé Documentos existentes
        </h3>

        <p-table [value]="documentosExistentes" class="p-datatable-sm">
          <ng-template pTemplate="header">
            <tr>
              <th>Nombre</th>
              <th style="width: 180px;">Acciones</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-doc>
            <tr>
              <td>{{ doc.nombre }}</td>
              <td class="flex gap-2">
                <button
                  pButton
                  icon="pi pi-eye"
                  class="p-button-rounded p-button-sm p-button-secondary"
                  pTooltip="Ver"
                  (click)="verDocumento(doc)"
                ></button>

                <button
                  pButton
                  icon="pi pi-download"
                  class="p-button-rounded p-button-sm p-button-info"
                  pTooltip="Descargar"
                  (click)="descargarDocumento(doc)"
                ></button>

                <button
                  pButton
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-sm p-button-danger"
                  pTooltip="Eliminar"
                  (click)="eliminarDocumento(doc)"
                ></button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <div class="col-span-2">
        <input
          #fileInput
          type="file"
          multiple
          (change)="onFileSelected($event)"
          class="block w-full border border-gray-300 p-2 rounded-md"
        />

        <div *ngIf="documentosSeleccionados.length > 0" class="mt-3">
          <div class="flex justify-between items-center">
            <p class="font-semibold text-gray-600">
              Archivos seleccionados ({{ documentosSeleccionados.length }})
            </p>
            <button
              pButton
              type="button"
              label="Quitar"
              icon="pi pi-times"
              class="p-button-text p-button-danger p-button-sm"
              (click)="limpiarInputArchivos()"
            ></button>
          </div>

          <ul class="mt-2 text-gray-600 text-sm list-disc pl-6">
            <li *ngFor="let f of documentosSeleccionados">{{ f.name }}</li>
          </ul>
        </div>
      </div>

      <div class="col-span-2 flex justify-end gap-4 mt-8">
        <button
          pButton
          type="button"
          class="p-button-warning"
          (click)="resetFormulario()"
        >
          Limpiar
        </button>

        <button
          pButton
          type="button"
          class="p-button-success"
          (click)="guardar()"
        >
          Guardar
        </button>
      </div>
    </form>
  </div>
</p-sidebar>

<!-- ‚úÖ TABLA DE EGRESADOS -->
<div class="m-10 bg-white p-8 shadow-lg rounded-md">
  <!-- ‚úÖ‚úÖ‚úÖ Tarjetas resumen arriba de la tabla (COLORES S√ìLIDOS) -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <div class="rounded-xl border border-sky-800 bg-sky-800 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Total Egresados</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.total }}</p>
      <p class="text-xs text-white/80">registros</p>
    </div>

    <div class="rounded-xl border border-emerald-700 bg-emerald-700 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Trabajando</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.trabajando }}</p>
      <p class="text-xs text-white/80">activos</p>
    </div>

    <div class="rounded-xl border border-rose-600 bg-rose-600 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Cesante</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.cesante }}</p>
      <p class="text-xs text-white/80">sin trabajo</p>
    </div>

    <div class="rounded-xl border border-cyan-700 bg-cyan-700 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Estudiando</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.estudiando }}</p>
      <p class="text-xs text-white/80">en formaci√≥n</p>
    </div>

    <div class="rounded-xl border border-amber-600 bg-amber-600 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Otro</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.otro }}</p>
      <p class="text-xs text-white/80">otros casos</p>
    </div>
  </div>

  <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
    <div class="flex items-center gap-3">
      <h2 class="text-xl font-bold text-sky-700">Listado de Egresados</h2>

      <button
        pButton
        type="button"
        icon="pi pi-plus"
        label="Nuevo / Editar"
        class="p-button-sm p-button-info"
        (click)="abrirFormularioNuevo()"
      ></button>

      <button
        pButton
        type="button"
        icon="pi pi-filter"
        label="Filtros"
        class="p-button-sm p-button-outlined p-button-secondary"
        (click)="modalFiltrosVisible = true"
      ></button>

      <button
        pButton
        type="button"
        icon="pi pi-filter-slash"
        label="Limpiar filtros"
        class="p-button-sm p-button-outlined p-button-secondary"
        (click)="dt.clear()"
      ></button>
    </div>

    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input
        pInputText
        type="text"
        placeholder="Buscar..."
        (input)="onGlobalFilter(dt, $event)"
      />
    </span>
  </div>

  <!-- ‚úÖ‚úÖ‚úÖ altura real para que scrollHeight="flex" funcione -->
  <div class="overflow-x-auto rounded-xl border border-gray-200 p-fluid h-[720px]">
    <p-table
      #dt
      [value]="egresados"
      [paginator]="true"
      [rows]="6"
      [rowsPerPageOptions]="[6, 10, 20, 50]"
      [loading]="loading"
      [rowHover]="true"
      [scrollable]="true"
      scrollHeight="flex"
      [tableStyle]="{ 'min-width': '1250px' }"
      class="p-datatable-sm p-datatable-gridlines"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
      [globalFilterFields]="[
        'Estudiante.nombreCompleto',
        'Estudiante.rut',
        'situacionActual',
        'empresa',
        'cargo',
        'anioIngresoLaboral',
        'telefono',
        'emailContacto'
      ]"
    >
      <!-- ‚úÖ‚úÖ‚úÖ HEADER PREMIUM (COLOR + CONTRASTE) -->
      <ng-template pTemplate="header">
        <tr class="text-sm bg-sky-700 text-white shadow-md">
          <th
            class="sticky top-0 z-30 w-[260px] bg-sky-700 text-white font-semibold border-b-4 border-sky-300"
            style="left: 0px;"
          >
            Estudiante
          </th>

          <th
            class="sticky top-0 z-30 w-[140px] bg-sky-700 text-white font-semibold border-b-4 border-sky-300"
            style="left: 260px;"
          >
            RUT
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[160px]">
            Situaci√≥n
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[160px]">
            A√±o Seguimiento
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[180px]">
            A√±o Ingreso Laboral
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[170px]">
            Empresa
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[170px]">
            Cargo
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[150px] text-center">
            Sueldo
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[140px] text-center">
            Tel√©fono
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[190px] text-center">
            Email
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[140px] text-center">
            Archivos
          </th>

          <th class="sticky top-0 z-10 bg-sky-700 text-white font-semibold border-b-4 border-sky-300 w-[120px] text-center">
            Acciones
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-egresado let-rowIndex="rowIndex">
        <tr class="text-sm" [ngClass]="{ 'bg-gray-50': rowIndex % 2 === 0 }">
          <td
            class="font-semibold text-sky-800 sticky bg-white z-20"
            style="left: 0px; min-width: 260px;"
          >
            {{ egresado.Estudiante?.nombreCompleto }}
          </td>

          <td
            class="text-gray-700 sticky bg-white z-20"
            style="left: 260px; min-width: 140px;"
          >
            {{ egresado.Estudiante?.rut }}
          </td>

          <td>
            <p-tag
              [value]="egresado.situacionActual"
              [severity]="getSituacionSeverity(egresado.situacionActual)"
            ></p-tag>
          </td>

          <td class="text-gray-700">{{ egresado.anioSeguimiento }}</td>
          <td class="text-gray-700">{{ egresado.anioIngresoLaboral || '-' }}</td>

          <td class="text-center">
            <span
              class="inline-flex items-center whitespace-nowrap max-w-[160px] px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 text-[15px] font-semibold truncate border border-indigo-200"
              [pTooltip]="egresado.empresa"
              tooltipPosition="top"
              [tooltipDisabled]="!(egresado.empresa && egresado.empresa.length > 18)"
            >
              {{ egresado.empresa || '-' }}
            </span>
          </td>

          <td class="text-center">
            <span
              class="inline-flex items-center whitespace-nowrap max-w-[160px] px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-[15px] font-semibold truncate border border-amber-200"
              [pTooltip]="egresado.cargo"
              tooltipPosition="top"
              [tooltipDisabled]="!(egresado.cargo && egresado.cargo.length > 18)"
            >
              {{ egresado.cargo || '-' }}
            </span>
          </td>

          <td class="text-center">
            <span
              class="inline-flex items-center whitespace-nowrap px-4 py-1 rounded-full font-bold text-green-800 text-[15px] bg-green-50 border border-green-200"
            >
              CLP {{ formatCLP(egresado.sueldo) }}
            </span>
          </td>

          <td class="text-center">
            <span
              class="inline-flex items-center whitespace-nowrap px-3 py-1 rounded-full bg-cyan-50 text-cyan-700 text-[15px] font-semibold border border-cyan-200"
            >
              {{ egresado.telefono || '-' }}
            </span>
          </td>

          <td class="text-center">
            <span
              class="inline-flex items-center whitespace-nowrap min-w-0 max-w-[260px] px-3 py-1 rounded-full bg-rose-50 text-rose-700 text-[15px] font-semibold border border-rose-200 overflow-hidden text-ellipsis"
              [pTooltip]="egresado.emailContacto"
              tooltipPosition="top"
              [tooltipDisabled]="!(egresado.emailContacto && egresado.emailContacto.length > 26)"
            >
              {{ egresado.emailContacto || '-' }}
            </span>
          </td>

          <td class="text-center">
            <button
              *ngIf="egresado.documentos?.length > 0"
              pButton
              type="button"
              class="p-button-sm p-button-text p-button-info"
              icon="pi pi-paperclip"
              (click)="abrirModalDocumentos(egresado)"
            ></button>

            <span
              *ngIf="egresado.documentos?.length > 0"
              class="ml-2 inline-flex items-center px-2 py-1 rounded-full bg-sky-50 text-sky-700 text-xs font-semibold"
            >
              {{ egresado.documentos.length }}
            </span>

            <span
              *ngIf="!egresado.documentos || egresado.documentos.length === 0"
              class="text-gray-400 italic text-xs"
            >
              Sin archivo
            </span>
          </td>

          <td class="text-center">
            <div class="flex justify-center gap-2">
              <button
                pButton
                icon="pi pi-pencil"
                class="p-button-rounded p-button-sm p-button-info"
                pTooltip="Editar"
                (click)="abrirEdicion(egresado)"
              ></button>

              <button
                pButton
                icon="pi pi-trash"
                class="p-button-rounded p-button-sm p-button-danger"
                pTooltip="Eliminar"
                (click)="eliminar(egresado)"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="12">
            <div class="py-10 text-center text-gray-500">
              <i class="pi pi-inbox text-3xl mb-3"></i>
              <p class="font-semibold">No hay egresados registrados</p>
              <p class="text-sm">Puedes crear uno desde ‚ÄúNuevo / Editar‚Äù.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- ‚úÖ‚úÖ‚úÖ ESTAD√çSTICAS (DONUTS) ABAJO DE LA TABLA -->
  <div class="mt-8">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold text-sky-700">üìä Estad√≠sticas</h3>
      <span class="text-xs text-gray-500">Basado en todos los registros</span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Donut: Situaci√≥n -->
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="font-semibold text-gray-700">Distribuci√≥n por situaci√≥n</p>
          <span class="text-xs text-gray-500">Global</span>
        </div>

        <div class="h-[260px]">
          <p-chart
            type="doughnut"
            [data]="donutSituacionData"
            [options]="donutOptions"
          ></p-chart>
        </div>
      </div>

      <!-- Donut: Documentos -->
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="font-semibold text-gray-700">Egresados con documentos</p>
          <span class="text-xs text-gray-500">Con / Sin</span>
        </div>

        <div class="h-[260px]">
          <p-chart
            type="doughnut"
            [data]="donutDocsData"
            [options]="donutOptions"
          ></p-chart>
        </div>
      </div>

      <!-- Donut: % por A√±o Seguimiento -->
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="font-semibold text-gray-700">% por a√±o (seguimiento)</p>
          <span class="text-xs text-gray-500">Top a√±os</span>
        </div>

        <div class="h-[260px]">
          <p-chart
            type="doughnut"
            [data]="donutAnioData"
            [options]="donutOptions"
          ></p-chart>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ MODAL FILTROS -->
<p-dialog
  [(visible)]="modalFiltrosVisible"
  [modal]="true"
  [style]="{ width: '720px' }"
  header="üîé Filtros"
>
  <div class="grid grid-cols-2 gap-4">
    <ng-container *ngFor="let f of filtrosConfig">
      <div class="col-span-2" *ngIf="f.type === 'dropdown'">
        <label class="block font-semibold mb-2">{{ f.label }}</label>
        <p-dropdown
          [options]="situaciones"
          optionLabel="label"
          optionValue="value"
          [showClear]="true"
          placeholder="Todas"
          class="w-full"
          (onChange)="dt.filter($event.value, f.field, 'equals')"
        ></p-dropdown>
      </div>

      <div class="col-span-2" *ngIf="f.type === 'text'">
        <label class="block font-semibold mb-2">{{ f.label }}</label>
        <input
          pInputText
          class="w-full"
          [placeholder]="f.placeholder || 'Filtrar...'"
          (input)="dt.filter($any($event.target).value, f.field, 'contains')"
        />
      </div>

      <div class="col-span-2" *ngIf="f.type === 'range-number'">
        <label class="block font-semibold mb-2">{{ f.label }}</label>

        <div class="grid grid-cols-2 gap-3">
          <p-inputNumber
            class="w-full"
            [useGrouping]="false"
            [placeholder]="f.placeholderMin || 'Min'"
            [ngModel]="filtroValores[f.field]?.min ?? null"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onRangoFiltroChange(dt, f.field, 'min', $event)"
          ></p-inputNumber>

          <p-inputNumber
            class="w-full"
            [useGrouping]="false"
            [placeholder]="f.placeholderMax || 'Max'"
            [ngModel]="filtroValores[f.field]?.max ?? null"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onRangoFiltroChange(dt, f.field, 'max', $event)"
          ></p-inputNumber>
        </div>
      </div>
    </ng-container>
  </div>

  <div class="flex justify-end gap-2 mt-6">
    <button
      pButton
      type="button"
      icon="pi pi-filter-slash"
      label="Limpiar"
      class="p-button-sm p-button-outlined p-button-secondary"
      (click)="dt.clear(); filtroValores = {}; modalFiltrosVisible = false"
    ></button>

    <button
      pButton
      type="button"
      icon="pi pi-check"
      label="Listo"
      class="p-button-sm p-button-info"
      (click)="modalFiltrosVisible = false"
    ></button>
  </div>
</p-dialog>

<p-dialog
  [(visible)]="modalDocsVisible"
  [modal]="true"
  [style]="{ width: '650px' }"
  header="üìé Documentos del Egresado"
>
  <div *ngIf="documentosModal.length === 0" class="text-gray-500 italic">
    No hay documentos disponibles.
  </div>

  <div *ngIf="documentosModal.length > 0" class="mt-3">
    <p-table [value]="documentosModal" class="p-datatable-sm">
      <ng-template pTemplate="header">
        <tr>
          <th>Nombre</th>
          <th style="width: 180px;">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-doc>
        <tr>
          <td>{{ doc.nombre }}</td>
          <td class="flex gap-2">
            <button
              pButton
              icon="pi pi-eye"
              class="p-button-rounded p-button-sm p-button-secondary"
              pTooltip="Ver"
              (click)="verDocumento(doc)"
            ></button>

            <button
              pButton
              icon="pi pi-download"
              class="p-button-rounded p-button-sm p-button-info"
              pTooltip="Descargar"
              (click)="descargarDocumento(doc)"
            ></button>

            <button
              pButton
              icon="pi pi-trash"
              class="p-button-rounded p-button-sm p-button-danger"
              pTooltip="Eliminar"
              (click)="eliminarDocumento(doc)"
            ></button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-dialog>
