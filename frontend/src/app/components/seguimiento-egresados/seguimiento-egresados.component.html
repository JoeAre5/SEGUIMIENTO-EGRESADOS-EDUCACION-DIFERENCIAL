<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- ‚úÖ HEADER -->
<div class="bg-white border-y mt-10 py-5 shadow-lg">
  <div class="flex items-center justify-between w-11/12">
    <div class="bg-sky-700 w-6/12 rounded-r-xl py-4">
      <h1 class="text-3xl text-white text-center font-bold">
        Seguimiento de Egresados
      </h1>
    </div>
  </div>
</div>

<!-- ‚úÖ FORMULARIO -->
<div class="m-10 bg-white p-10 shadow-lg rounded-md">
  <form [formGroup]="formulario" class="grid grid-cols-2 gap-6">

    <!-- ‚úÖ Datos principales -->
    <div class="col-span-2">
      <h2 class="text-xl font-bold text-sky-700">Informaci√≥n General</h2>
      <hr class="my-3" />
    </div>

    <!-- ‚úÖ SELECTOR MODO -->
    <div class="col-span-2 flex gap-4 items-center mb-2">
      <label class="font-semibold">Modo:</label>

      <button
        pButton
        type="button"
        class="p-button-sm"
        [class.p-button-info]="modoEstudiante === 'existente'"
        [class.p-button-outlined]="modoEstudiante !== 'existente'"
        (click)="modoEstudiante = 'existente'"
      >
        Seleccionar Estudiante
      </button>

      <button
        pButton
        type="button"
        class="p-button-sm"
        [class.p-button-success]="modoEstudiante === 'nuevo'"
        [class.p-button-outlined]="modoEstudiante !== 'nuevo'"
        (click)="modoEstudiante = 'nuevo'"
      >
        Crear Estudiante Nuevo
      </button>
    </div>

    <!-- ‚úÖ MODO EXISTENTE -->
    <div class="col-span-2" *ngIf="modoEstudiante === 'existente'">
      <label class="block font-semibold mb-2">Seleccionar Estudiante *</label>

      <p-dropdown
        [options]="estudiantes"
        [(ngModel)]="estudianteSeleccionado"
        [ngModelOptions]="{ standalone: true }"
        optionLabel="nombreCompleto"
        placeholder="Buscar por nombre o rut"
        [filter]="true"
        filterBy="nombreCompleto,rut"
        [showClear]="true"
        class="w-full"
      >
        <ng-template let-estudiante pTemplate="item">
          <div class="flex flex-col">
            <span class="font-bold">{{ estudiante.nombreCompleto }}</span>
            <small class="text-gray-500">{{ estudiante.rut }}</small>
          </div>
        </ng-template>
      </p-dropdown>

      <small class="text-red-500" *ngIf="intentoGuardar && !estudianteSeleccionado">
        Debes seleccionar un estudiante.
      </small>
    </div>

    <!-- ‚úÖ MODO NUEVO -->
    <div class="col-span-2" *ngIf="modoEstudiante === 'nuevo'">
      <h3 class="text-lg font-bold text-sky-700 mt-2">üÜï Nuevo Estudiante</h3>

      <div class="grid grid-cols-2 gap-6 mt-4">
        <div>
          <label class="block font-semibold mb-2">RUT *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.rut"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: 20.123.456-7"
            class="w-full"
          />
        </div>

        <div>
          <label class="block font-semibold mb-2">A√±o ingreso *</label>
          <p-inputNumber
            [(ngModel)]="nuevoEstudiante.agnioIngreso"
            [ngModelOptions]="{ standalone: true }"
            class="w-full"
            [useGrouping]="false"
          ></p-inputNumber>
        </div>

        <div>
          <label class="block font-semibold mb-2">Nombre *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.nombre"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: Juan"
            class="w-full"
          />
        </div>

        <div>
          <label class="block font-semibold mb-2">ID Plan *</label>
          <p-inputNumber
            [(ngModel)]="nuevoEstudiante.idPlan"
            [ngModelOptions]="{ standalone: true }"
            class="w-full"
            [useGrouping]="false"
          ></p-inputNumber>
        </div>

        <div class="col-span-2">
          <label class="block font-semibold mb-2">Apellido *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.apellido"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: P√©rez"
            class="w-full"
          />
        </div>
      </div>
    </div>

    <!-- ‚úÖ fecha egreso -->
    <div>
      <label class="block font-semibold mb-2">Fecha de Egreso *</label>
      <p-calendar
        formControlName="fechaEgreso"
        [showIcon]="true"
        dateFormat="yy-mm-dd"
        class="w-full"
      ></p-calendar>
    </div>

    <!-- ‚úÖ situaci√≥n actual -->
    <div>
      <label class="block font-semibold mb-2">Situaci√≥n Actual *</label>
      <p-dropdown
        formControlName="situacionActual"
        [options]="situaciones"
        placeholder="Seleccionar"
        class="w-full"
      ></p-dropdown>
    </div>

    <!-- empresa -->
    <div>
      <label class="block font-semibold mb-2">Empresa</label>
      <input pInputText formControlName="empresa" class="w-full" />
    </div>

    <!-- cargo -->
    <div>
      <label class="block font-semibold mb-2">Cargo</label>
      <input pInputText formControlName="cargo" class="w-full" />
    </div>

    <!-- sueldo -->
    <div>
      <label class="block font-semibold mb-2">Sueldo (CLP)</label>
      <p-inputNumber formControlName="sueldo" class="w-full"></p-inputNumber>
    </div>

    <!-- A√±o seguimiento -->
    <div>
      <label class="block font-semibold mb-2">A√±o Seguimiento *</label>
      <p-inputNumber formControlName="anioSeguimiento" class="w-full" [useGrouping]="false"></p-inputNumber>
    </div>

    <!-- ‚úÖ DOCUMENTOS -->
    <div class="col-span-2 mt-6">
      <h2 class="text-xl font-bold text-sky-700">Documentos</h2>
      <hr class="my-3" />
    </div>

    <div class="col-span-2">
      <input
        type="file"
        multiple
        (change)="onFileSelected($event)"
        class="block w-full border border-gray-300 p-2 rounded-md"
      />
    </div>

    <!-- ‚úÖ Botones -->
    <div class="col-span-2 flex justify-end gap-4 mt-8">
      <button pButton type="button" class="p-button-secondary" (click)="volverMenu()">
        Volver
      </button>

      <button pButton type="button" class="p-button-warning" (click)="resetFormulario()">
        Limpiar
      </button>

      <button pButton type="button" class="p-button-success" (click)="guardar()">
        Guardar
      </button>
    </div>
  </form>
</div>

<!-- ‚úÖ TABLA DE EGRESADOS -->
<div class="m-10 bg-white p-8 shadow-lg rounded-md">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-sky-700">Listado de Egresados</h2>

    <!-- ‚úÖ BUSQUEDA GLOBAL -->
    <div class="flex gap-4 items-center">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input
          pInputText
          type="text"
          placeholder="Buscar..."
          (input)="onGlobalFilter(dt, $event)"
        />
      </span>
    </div>
  </div>

  <p-table
    #dt
    [value]="egresados"
    [paginator]="true"
    [rows]="10"
    [loading]="loading"
    [rowHover]="true"
    class="p-datatable-sm"
    [globalFilterFields]="['Estudiante.nombreCompleto','Estudiante.rut','situacionActual','empresa','cargo']"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>Estudiante</th>
        <th>RUT</th>
        <th>Situaci√≥n</th>
        <th>A√±o Seguimiento</th>
        <th>Empresa</th>
        <th>Cargo</th>
        <th>Sueldo</th>
        <th>Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-egresado>
      <tr>
        <td>{{ egresado.Estudiante?.nombreCompleto }}</td>
        <td>{{ egresado.Estudiante?.rut }}</td>

        <td>
          <p-tag
            [value]="egresado.situacionActual"
            [severity]="getSituacionSeverity(egresado.situacionActual)"
          ></p-tag>
        </td>

        <td>{{ egresado.anioSeguimiento }}</td>
        <td>{{ egresado.empresa || '-' }}</td>
        <td>{{ egresado.cargo || '-' }}</td>

        <td>
          <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold">
            CLP{{ formatCLP(egresado.sueldo) }}
          </span>
        </td>

        <!-- ‚úÖ BOTONES -->
        <td class="flex gap-2 justify-center">
          <button
            pButton
            icon="pi pi-pencil"
            class="p-button-rounded p-button-info"
            pTooltip="Editar"
            (click)="abrirEdicion(egresado)"
          ></button>

          <button
            pButton
            icon="pi pi-trash"
            class="p-button-rounded p-button-danger"
            pTooltip="Eliminar"
            (click)="eliminar(egresado)"
          ></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- ‚úÖ MODAL EDICION COMPLETA -->
<p-dialog
  [(visible)]="editDialogVisible"
  [modal]="true"
  [style]="{ width: '650px' }"
  [closable]="true"
  header="‚úèÔ∏è Editar Seguimiento"
>
  <form [formGroup]="editFormulario" class="grid grid-cols-2 gap-4">

    <div class="col-span-2">
      <label class="font-semibold block mb-2">Situaci√≥n *</label>
      <p-dropdown
        formControlName="situacionActual"
        [options]="situaciones"
        class="w-full"
      ></p-dropdown>
    </div>

    <div>
      <label class="font-semibold block mb-2">Empresa</label>
      <input pInputText formControlName="empresa" class="w-full" />
    </div>

    <div>
      <label class="font-semibold block mb-2">Cargo</label>
      <input pInputText formControlName="cargo" class="w-full" />
    </div>

    <div>
      <label class="font-semibold block mb-2">Sueldo</label>
      <p-inputNumber formControlName="sueldo" class="w-full"></p-inputNumber>
    </div>

    <div>
      <label class="font-semibold block mb-2">A√±o Seguimiento *</label>
      <p-inputNumber formControlName="anioSeguimiento" class="w-full"></p-inputNumber>
    </div>

    <div>
      <label class="font-semibold block mb-2">Tel√©fono</label>
      <input pInputText formControlName="telefono" class="w-full" />
    </div>

    <div>
      <label class="font-semibold block mb-2">Email</label>
      <input pInputText formControlName="emailContacto" class="w-full" />
    </div>

    <div class="col-span-2">
      <label class="font-semibold block mb-2">Direcci√≥n</label>
      <input pInputText formControlName="direccion" class="w-full" />
    </div>

    <div class="col-span-2">
      <label class="font-semibold block mb-2">LinkedIn</label>
      <input pInputText formControlName="linkedin" class="w-full" />
    </div>

    <div class="col-span-2">
      <label class="font-semibold block mb-2">Contacto Alternativo</label>
      <input pInputText formControlName="contactoAlternativo" class="w-full" />
    </div>

    <div class="col-span-2 flex justify-end gap-3 mt-6">
      <button
        pButton
        type="button"
        label="Cancelar"
        class="p-button-secondary"
        (click)="editDialogVisible = false"
      ></button>

      <button
        pButton
        type="button"
        label="Guardar"
        class="p-button-success"
        (click)="guardarEdicion()"
      ></button>
    </div>
  </form>
</p-dialog>
