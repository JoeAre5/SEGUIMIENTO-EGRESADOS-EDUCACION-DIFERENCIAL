<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>


<p-dialog
  *ngIf="isEgresado && consentimientoVisible"
  [visible]="true"
  [modal]="true"
  [closable]="false"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="false"
  [style]="{ width: '680px' }"
  header="üìå Consentimiento informado"
  (onHide)="formulario.enable({ emitEvent: false })"
>
  <div class="text-slate-700 space-y-3">
    <p class="font-semibold text-sky-800">
      Autorizaci√≥n para el uso de informaci√≥n con fines institucionales
    </p>

    <p>
      La Universidad solicita tu consentimiento para utilizar la informaci√≥n que registres en este
      formulario (por ejemplo: situaci√≥n laboral, instituci√≥n/establecimiento, cargo, nivel de rentas
      y datos de contacto) con fines exclusivamente acad√©micos e institucionales, tales como:
      seguimiento de egresados, elaboraci√≥n de estad√≠sticas y mejora de programas.
    </p>

    <p>
      Tu informaci√≥n ser√° tratada de manera confidencial y utilizada √∫nicamente por personal
      autorizado. Puedes decidir no otorgar tu consentimiento; sin embargo, en ese caso no podr√°s
      editar ni actualizar tu informaci√≥n en el sistema.
    </p>

    <p class="text-sm text-slate-500">
      Selecciona una opci√≥n para continuar:
    </p>

    <div class="flex justify-end gap-2 pt-2">
      <button
        pButton
        type="button"
        class="p-button-outlined p-button-secondary"
        label="No acepto"
        icon="pi pi-times"
        [disabled]="consentimientoCargando"
        (click)="rechazarConsentimiento()"
      ></button>

      <button
        pButton
        type="button"
        class="p-button-info"
        label="Acepto"
        icon="pi pi-check"
        [loading]="consentimientoCargando"
        (click)="aceptarConsentimiento()"
      ></button>
    </div>
  </div>
</p-dialog>


<div class="bg-white border-y mt-10 py-5 shadow-lg">
  <div class="flex items-center justify-between w-11/12">
    <button
      pButton
      type="button"
      icon="pi pi-arrow-left"
      label="Volver"
      class="p-button-outlined p-button-secondary rounded-full shadow-sm px-4 py-2"
      (click)="volverMenu()"
    ></button>

    <div class="bg-sky-700 w-6/12 rounded-r-xl py-4">
      <h1 class="text-3xl text-white text-center font-bold">
        Seguimiento de Egresados
      </h1>
    </div>
  </div>
</div>


<div class="m-10 bg-white p-8 shadow-lg rounded-md" *ngIf="isEgresado">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-sky-700">
      üìÑ Formulario Seguimiento Egresados
    </h2>
  </div>

  <div id="formulario-egresados" class="bg-white p-2 max-h-[75vh] overflow-y-auto">
    <ng-container *ngTemplateOutlet="formularioTemplate"></ng-container>
  </div>
</div>


<p-sidebar
  *ngIf="!isEgresado"
  [(visible)]="drawerFormulario"
  position="right"
  [baseZIndex]="10000"
  [style]="{ width: '720px' }"
  [modal]="true"
>
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-sky-700">
      üìÑ Formulario Seguimiento Egresados
    </h2>

    <button
      pButton
      type="button"
      icon="pi pi-times"
      class="p-button-rounded p-button-text p-button-danger"
      (click)="cerrarDrawerFormulario()"
      pTooltip="Cerrar"
    ></button>
  </div>

  <div id="formulario-egresados" class="bg-white p-2 max-h-[75vh] overflow-y-auto">
    <ng-container *ngTemplateOutlet="formularioTemplate"></ng-container>
  </div>
</p-sidebar>


<ng-template #formularioTemplate>
  <form [formGroup]="formulario" class="grid grid-cols-2 gap-6">
    <div class="col-span-2">
      <h2 class="text-xl font-bold text-sky-700">Informaci√≥n General</h2>
      <hr class="my-3" />
    </div>

  
    <div class="col-span-2" *ngIf="isEgresado">
      <div class="bg-sky-50 border border-sky-200 rounded-md p-3">
        <div class="font-semibold text-sky-700">Egresado:</div>
        <div class="text-gray-900">
          {{ estudianteSeleccionado?.nombreCompleto || '‚Äî' }}
        </div>
        <small class="text-gray-600">
          RUT: {{ estudianteSeleccionado?.rut || '‚Äî' }}
        </small>
      </div>
    </div>

    <!-- si es EGRESADO, ocultar botones de modo -->
    <div class="col-span-2 flex gap-4 items-center mb-2" *ngIf="!isEgresado">
      <label class="font-semibold">Modo:</label>

      <button
        pButton
        type="button"
        class="p-button-sm"
        [class.p-button-info]="modoEstudiante === 'existente'"
        [class.p-button-outlined]="modoEstudiante !== 'existente'"
        (click)="modoEstudiante = 'existente'"
      >
        Seleccionar Estudiante
      </button>

      <button
        pButton
        type="button"
        class="p-button-sm"
        [class.p-button-success]="modoEstudiante === 'nuevo'"
        [class.p-button-outlined]="modoEstudiante !== 'nuevo'"
        (click)="cambiarAModoNuevo()"
      >
        Crear Estudiante Nuevo
      </button>
    </div>

    <!-- seleccionar estudiante -->
    <div class="col-span-2" *ngIf="!isEgresado && modoEstudiante === 'existente'">
      <label class="block font-semibold mb-2">Seleccionar Estudiante *</label>

      <p-dropdown
        [options]="estudiantes"
        [(ngModel)]="estudianteSeleccionado"
        [ngModelOptions]="{ standalone: true }"
        optionLabel="nombreCompleto"
        dataKey="idEstudiante"
        placeholder="Buscar por nombre o rut"
        [filter]="true"
        filterBy="nombreCompleto,rut"
        [showClear]="true"
        class="w-full"
        (onChange)="onEstudianteChange()"
      >
        <ng-template let-estudiante pTemplate="item">
          <div class="flex flex-col">
            <span class="font-bold">{{ estudiante.nombreCompleto }}</span>
            <small class="text-gray-500">{{ estudiante.rut }}</small>
          </div>
        </ng-template>
      </p-dropdown>

      <small class="text-red-500" *ngIf="intentoGuardar && !estudianteSeleccionado">
        Debes seleccionar un estudiante.
      </small>
    </div>


    <div
      class="col-span-2"
      *ngIf="!isEgresado && modoEstudiante === 'existente' && estudianteSeleccionado"
    >
      <label class="block font-semibold mb-2">RUT (con DV) *</label>
      <input
        pInputText
        [(ngModel)]="estudianteSeleccionado.rut"
        [ngModelOptions]="{ standalone: true }"
        placeholder="Ej: 10.000.196-9"
        class="w-full"
        maxlength="12"
        inputmode="text"
        autocomplete="off"
        (input)="onRutInputExistente()"
      />
      <small class="text-red-500" *ngIf="false">RUT inv√°lido.</small>
    </div>


    <div class="col-span-2" *ngIf="modoEstudiante === 'existente' && estudianteSeleccionado">
      <label class="block font-semibold mb-2">Plan actual (info)</label>
      <input
        pInputText
        formControlName="planEstudios"
        class="w-full"
        placeholder="Se cargar√° autom√°ticamente"
        readonly
      />
      <small class="text-gray-500">
        Este campo es informativo (viene del seguimiento/plan actual).
      </small>
    </div>


    <div
      class="col-span-2"
      *ngIf="!isEgresado && modoEstudiante === 'existente' && estudianteSeleccionado"
    >
      <label class="block font-semibold mb-2">Plan de estudios (editable) *</label>

      <p-dropdown
        [options]="planesOptions"
        [(ngModel)]="planSeleccionadoId"
        [ngModelOptions]="{ standalone: true }"
        placeholder="Selecciona un plan"
        [filter]="true"
        filterBy="label"
        [showClear]="true"
        class="w-full"
      ></p-dropdown>

      <small
        class="text-xs text-gray-500"
        *ngIf="planOriginalId && planSeleccionadoId && planSeleccionadoId !== planOriginalId"
      >
        üìå Cambiar√°s el plan en la BD del estudiante al guardar.
      </small>

      <small class="text-red-500" *ngIf="intentoGuardar && !planSeleccionadoId">
        Debes seleccionar un plan.
      </small>
    </div>

    <!-- NUEVO: crear estudiante -->
    <div class="col-span-2" *ngIf="!isEgresado && modoEstudiante === 'nuevo'">
      <h3 class="text-lg font-bold text-sky-700 mt-2">üÜï Nuevo Estudiante</h3>

      <div class="grid grid-cols-2 gap-6 mt-4">
        <div>
          <label class="block font-semibold mb-2">RUT (con DV) *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.rut"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: 10.000.196-9"
            class="w-full"
            maxlength="12"
            inputmode="text"
            autocomplete="off"
            (input)="onRutInputNuevo()"
          />
          <small class="text-red-500" *ngIf="false">RUT inv√°lido.</small>
        </div>

        <div>
          <label class="block font-semibold mb-2">A√±o ingreso *</label>
          <p-inputNumber
            [(ngModel)]="nuevoEstudiante.agnioIngreso"
            [ngModelOptions]="{ standalone: true }"
            class="w-full"
            [useGrouping]="false"
          ></p-inputNumber>
        </div>

        <div>
          <label class="block font-semibold mb-2">Nombre *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.nombre"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: Juan"
            class="w-full"
          />
        </div>

        <div>
          <label class="block font-semibold mb-2">Plan de Estudios *</label>

          <p-dropdown
            [options]="planesOptions"
            [(ngModel)]="nuevoEstudiante.idPlan"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Selecciona un plan"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
            class="w-full"
          ></p-dropdown>

          <small class="text-red-500" *ngIf="intentoGuardar && !nuevoEstudiante.idPlan">
            Debes seleccionar un plan.
          </small>
        </div>

        <div class="col-span-2">
          <label class="block font-semibold mb-2">Apellido *</label>
          <input
            pInputText
            [(ngModel)]="nuevoEstudiante.apellido"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Ej: P√©rez"
            class="w-full"
          />
        </div>
      </div>
    </div>


    <!-- A√±o fin estudios -->
    <div>
      <label class="block font-semibold mb-2">A√±o de cohorte a la que pertenece *</label>
      <p-inputNumber
        formControlName="anioFinEstudios"
        class="w-full"
        [useGrouping]="false"
        placeholder="Ej: 2024"
      ></p-inputNumber>

      <small class="text-red-500" *ngIf="isInvalid('anioFinEstudios')">
        <ng-container *ngIf="getError('anioFinEstudios')?.required">
          Debes indicar el a√±o de finalizaci√≥n.
        </ng-container>
        <ng-container *ngIf="getError('anioFinEstudios')?.min">A√±o demasiado bajo.</ng-container>
        <ng-container *ngIf="getError('anioFinEstudios')?.max">A√±o demasiado alto.</ng-container>
      </small>
    </div>

    <!-- Situaci√≥n -->
    <div>
      <label class="block font-semibold mb-2">Situaci√≥n Actual *</label>
      <p-dropdown
        formControlName="situacionActual"
        [options]="situaciones"
        placeholder="Seleccionar"
        class="w-full"
      ></p-dropdown>
    </div>

    <div class="col-span-2" *ngIf="formulario.get('situacionActual')?.value === 'Otro'">
      <label class="block font-semibold mb-2">Especifica (Otro) *</label>
      <input
        pInputText
        formControlName="situacionActualOtro"
        class="w-full"
        placeholder="Ej: emprendimiento, licencia, etc."
      />
      <small class="text-red-500" *ngIf="formHasError('situacionActualOtroRequerido')">
        Debes especificar la situaci√≥n.
      </small>
    </div>

    <!-- Empresa / cargo -->
    <div>
      <label class="block font-semibold mb-2">Instituci√≥n o establecimiento</label>
      <input pInputText formControlName="empresa" class="w-full" />
    </div>

    <div>
      <label class="block font-semibold mb-2">Cargo</label>
      <input pInputText formControlName="cargo" class="w-full" />
    </div>

    <!-- V√≠a ingreso -->
    <div>
      <label class="block font-semibold mb-2">V√≠a de ingreso</label>
      <p-dropdown
        formControlName="viaIngreso"
        [options]="viasIngreso"
        placeholder="Seleccionar"
        class="w-full"
      ></p-dropdown>
    </div>

    <div *ngIf="formulario.get('viaIngreso')?.value === 'Otro'">
      <label class="block font-semibold mb-2">Especifica (V√≠a de ingreso)</label>
      <input pInputText formControlName="viaIngresoOtro" class="w-full" />
      <small class="text-red-500" *ngIf="formHasError('viaIngresoOtroRequerido')">
        Debes especificar la v√≠a de ingreso.
      </small>
    </div>

    <!-- A√±o ingreso carrera -->
    <div>
      <label class="block font-semibold mb-2">A√±o ingreso carrera</label>
      <p-inputNumber
        formControlName="anioIngresoCarrera"
        class="w-full"
        [useGrouping]="false"
        placeholder="Ej: 2019"
      ></p-inputNumber>

      <small class="text-red-500" *ngIf="isInvalid('anioIngresoCarrera')">
        <ng-container *ngIf="getError('anioIngresoCarrera')?.min">A√±o demasiado bajo.</ng-container>
        <ng-container *ngIf="getError('anioIngresoCarrera')?.max">A√±o demasiado alto.</ng-container>
      </small>

      <small class="text-red-500" *ngIf="formHasError('anioIngresoCarreraMayorQueFin')">
        A√±o ingreso carrera debe ser menor o igual al a√±o fin de estudios.
      </small>
    </div>

    <!-- G√©nero -->
    <div>
      <label class="block font-semibold mb-2">G√©nero</label>
      <p-dropdown
        formControlName="genero"
        [options]="generos"
        placeholder="Seleccionar"
        class="w-full"
      ></p-dropdown>
    </div>

    <!-- Tiempo b√∫squeda -->
    <div class="col-span-2">
      <label class="block font-semibold mb-2">Tiempo de b√∫squeda de trabajo</label>
      <p-dropdown
        formControlName="tiempoBusquedaTrabajo"
        [options]="tiemposBusquedaTrabajo"
        placeholder="Seleccionar"
        class="w-full"
      ></p-dropdown>
    </div>

    <!-- Sector laboral -->
    <div>
      <label class="block font-semibold mb-2">Sector laboral</label>
      <p-dropdown
        formControlName="sectorLaboral"
        [options]="sectoresLaborales"
        placeholder="Seleccionar"
        class="w-full"
      ></p-dropdown>
    </div>

    <div *ngIf="formulario.get('sectorLaboral')?.value === 'Otro'">
      <label class="block font-semibold mb-2">Especifica (Sector)</label>
      <input pInputText formControlName="sectorLaboralOtro" class="w-full" />
      <small class="text-red-500" *ngIf="formHasError('sectorLaboralOtroRequerido')">
        Debes especificar el sector.
      </small>
    </div>

    <!-- Tipo establecimiento -->
    <div>
      <label class="block font-semibold mb-2">Tipo de establecimiento</label>
      <p-dropdown
        formControlName="tipoEstablecimiento"
        [options]="tipoEstablecimiento"
        placeholder="Seleccionar"
        class="w-full"
      ></p-dropdown>
    </div>

    <div *ngIf="formulario.get('tipoEstablecimiento')?.value === 'Otro'">
      <label class="block font-semibold mb-2">Especifica (Tipo establecimiento)</label>
      <input pInputText formControlName="tipoEstablecimientoOtro" class="w-full" />
      <small class="text-red-500" *ngIf="formHasError('tipoEstablecimientoOtroRequerido')">
        Debes especificar el tipo de establecimiento.
      </small>
    </div>

    <!-- Nivel de rentas (radios) -->
    <div class="col-span-2">
      <label class="font-bold block mb-2">
        Nivel de Rentas <span class="text-red-500">*</span>
      </label>

      <div class="flex flex-column gap-2">
        <div class="flex align-items-center gap-2">
          <p-radioButton
            name="nivelRentas"
            inputId="nr_1"
            [value]="'Sueldo m√≠nimo ($500.000)'"
            formControlName="nivelRentas"
          ></p-radioButton>
          <label for="nr_1">Sueldo m√≠nimo ($500.000)</label>
        </div>

        <div class="flex align-items-center gap-2">
          <p-radioButton
            name="nivelRentas"
            inputId="nr_2"
            [value]="'Entre $500.001 y $1.000.000'"
            formControlName="nivelRentas"
          ></p-radioButton>
          <label for="nr_2">Entre $500.001 y $1.000.000</label>
        </div>

        <div class="flex align-items-center gap-2">
          <p-radioButton
            name="nivelRentas"
            inputId="nr_3"
            [value]="'Entre $1.000.001 y $1.500.000'"
            formControlName="nivelRentas"
          ></p-radioButton>
          <label for="nr_3">Entre $1.000.001 y $1.500.000</label>
        </div>

        <div class="flex align-items-center gap-2">
          <p-radioButton
            name="nivelRentas"
            inputId="nr_4"
            [value]="'M√°s de $1.500.001'"
            formControlName="nivelRentas"
          ></p-radioButton>
          <label for="nr_4">M√°s de $1.500.001</label>
        </div>
      </div>

      <small
        class="p-error"
        *ngIf="formulario.get('nivelRentas')?.touched && formulario.get('nivelRentas')?.invalid"
      >
        Debes seleccionar un nivel de rentas.
      </small>
    </div>

    <!-- A√±o ingreso laboral -->
    <div>
      <label class="block font-semibold mb-2">A√±o Ingreso Laboral</label>
      <p-inputNumber
        formControlName="anioIngresoLaboral"
        class="w-full"
        [useGrouping]="false"
        placeholder="Ej: 2024"
      ></p-inputNumber>

      <small class="text-red-500" *ngIf="isInvalid('anioIngresoLaboral')">
        <ng-container *ngIf="getError('anioIngresoLaboral')?.min">
          A√±o ingreso laboral demasiado bajo.
        </ng-container>
        <ng-container *ngIf="getError('anioIngresoLaboral')?.max">
          A√±o ingreso laboral demasiado alto.
        </ng-container>
      </small>

      <small class="text-red-500" *ngIf="formHasError('anioIngresoLaboralMenorQueFin')">
        A√±o ingreso laboral debe ser mayor o igual al a√±o fin de estudios.
      </small>
    </div>

    <!-- Tel√©fono -->
    <div>
      <label class="block font-semibold mb-2">Tel√©fono de contacto</label>
      <input
        pInputText
        formControlName="telefono"
        class="w-full"
        placeholder="Ej: +56 9 12345678"
        (input)="onTelefonoInput()"
      />
      <small class="text-red-500" *ngIf="isInvalid('telefono')">Tel√©fono inv√°lido.</small>
    </div>

    <!-- Email -->
    <div class="col-span-2">
      <label class="block font-semibold mb-2">Correo</label>
      <input
        pInputText
        formControlName="emailContacto"
        class="w-full"
        placeholder="Ej: nombre@dominio.cl"
      />
      <small class="text-red-500" *ngIf="isInvalid('emailContacto')">Email inv√°lido.</small>
    </div>

    <!-- LinkedIn -->
    <div class="col-span-2">
      <label class="block font-semibold mb-2">LinkedIn</label>
      <input
        pInputText
        formControlName="linkedin"
        class="w-full"
        placeholder="Ej: https://linkedin.com/in/usuario"
      />
      <small class="text-red-500" *ngIf="isInvalid('linkedin')">URL de LinkedIn inv√°lida.</small>
    </div>


    <div class="col-span-2 mt-6">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-sky-700 flex items-center gap-2">
          <i class="pi pi-paperclip"></i>
          Documentos
        </h3>
      </div>

      <div class="mt-3 bg-slate-50 border border-slate-200 rounded-xl p-4">
        <div class="flex flex-col gap-2">
          <label class="block font-semibold text-slate-700">Subir documentos</label>

          <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
            <input
              #fileInputDocs
              type="file"
              multiple
              class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0
                     file:text-sm file:font-semibold file:bg-sky-600 file:text-white
                     hover:file:bg-sky-700"
              (change)="onFileSelected($event)"
            />

            <button
              *ngIf="documentosSeleccionados?.length"
              pButton
              type="button"
              class="p-button-sm p-button-outlined p-button-secondary"
              icon="pi pi-trash"
              label="Quitar"
              (click)="limpiarInputArchivos()"
            ></button>
          </div>

          <small class="text-slate-500">
            Puedes seleccionar uno o m√°s archivos. Se adjuntar√°n al guardar.
          </small>
        </div>


        <div class="mt-4" *ngIf="documentosSeleccionados?.length">
          <p class="font-semibold text-slate-700 mb-2">Seleccionados:</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <div
              *ngFor="let f of documentosSeleccionados"
              class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2"
            >
              <div class="flex flex-col">
                <span class="font-medium text-slate-800 truncate">{{ f.name }}</span>
                <small class="text-slate-500">{{ f.size }} bytes</small>
              </div>
              <i class="pi pi-file text-slate-400"></i>
            </div>
          </div>
        </div>

        <!-- Documentos existentes -->
        <div class="mt-6">
          <p class="font-semibold text-slate-700 mb-2">Existentes:</p>

          <div *ngIf="documentosExistentes?.length; else sinDocs" class="flex flex-col gap-3">
            <div
              *ngFor="let doc of documentosExistentes"
              class="bg-white border border-slate-200 rounded-xl p-4 flex items-center justify-between gap-4"
            >
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <i class="pi pi-file text-slate-400"></i>
                  <span class="font-semibold text-slate-900 truncate">{{ doc.nombre }}</span>
                </div>
                <small class="text-slate-500 truncate block">{{ doc.url }}</small>
              </div>

              <div class="flex items-center gap-2 shrink-0">
                <button
                  pButton
                  type="button"
                  class="p-button-sm p-button-outlined p-button-info"
                  icon="pi pi-eye"
                  pTooltip="Ver"
                  (click)="verDocumento(doc)"
                ></button>

                <button
                  pButton
                  type="button"
                  class="p-button-sm p-button-outlined p-button-help"
                  icon="pi pi-download"
                  pTooltip="Descargar"
                  (click)="descargarDocumento(doc)"
                ></button>

                <button
                  pButton
                  type="button"
                  class="p-button-sm p-button-outlined p-button-danger"
                  icon="pi pi-trash"
                  pTooltip="Eliminar"
                  (click)="eliminarDocumento(doc)"
                ></button>
              </div>
            </div>
          </div>

          <ng-template #sinDocs>
            <div class="bg-white border border-dashed border-slate-300 rounded-xl p-4 text-slate-500">
              No hay documentos cargados.
            </div>
          </ng-template>
        </div>
      </div>
    </div>


    <div class="col-span-2 flex justify-end gap-3 mt-10">
      <button
        pButton
        type="button"
        class="p-button-outlined p-button-secondary rounded-lg px-5"
        icon="pi pi-undo"
        label="Limpiar"
        (click)="resetFormulario()"
      ></button>

      <button
        pButton
        type="button"
        class="p-button-success rounded-lg px-6 shadow-md"
        icon="pi pi-check"
        label="Guardar"
        (click)="guardar()"
      ></button>
    </div>
  </form>
</ng-template>



<!-- EXCEL (IMPORT / EXPORT) - SOLO ADMIN -->
<div *ngIf="!isEgresado" class="mb-4">
  <div
    class="bg-white border border-sky-100 rounded-xl shadow-sm p-4 flex flex-col gap-3
           sm:flex-row sm:items-center sm:justify-between"
  >
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-sky-50 border border-sky-100 flex items-center justify-center">
        <i class="pi pi-file-excel text-sky-700 text-lg"></i>
      </div>

      <div class="leading-tight">
        <div class="font-bold text-sky-800">Excel (Importar / Exportar)</div>
        <small class="text-slate-500">
          Usa la plantilla para cargar egresados o exporta la tabla actual.
        </small>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 items-center justify-end">
      <input
        #fileInputExcel
        type="file"
        accept=".xlsx,.xls"
        class="hidden"
        (change)="onExcelSelected($event)"
      />

      <!-- Plantilla -->
      <button
        pButton
        type="button"
        icon="pi pi-download"
        label="Plantilla"
        (click)="descargarPlantillaExcel()"
        [disabled]="excelImportando"
        class="p-button-sm p-button-outlined rounded-lg px-4
               border-sky-600 text-sky-700 hover:bg-sky-50 shadow-sm"
      ></button>

      <!-- Importar -->
      <button
        pButton
        type="button"
        icon="pi pi-upload"
        label="Importar"
        (click)="abrirSelectorExcel()"
        [disabled]="excelImportando"
        class="p-button-sm rounded-lg px-4 shadow-sm
               bg-sky-700 border-sky-700 hover:bg-sky-800 hover:border-sky-800 text-white"
      ></button>

      <!-- Exportar -->
      <button
        pButton
        type="button"
        icon="pi pi-external-link"
        label="Exportar"
        (click)="exportarEgresadosExcel()"
        [disabled]="excelImportando || loading"
        class="p-button-sm p-button-outlined rounded-lg px-4
               border-sky-700 text-sky-800 hover:bg-sky-50 shadow-sm"
      ></button>

      <!-- Progreso -->
      <div
        *ngIf="excelImportando"
        class="flex items-center gap-2 ml-1 bg-sky-50 border border-sky-100 rounded-lg px-3 py-2"
      >
        <i class="pi pi-spin pi-spinner text-sky-700"></i>
        <span class="text-sm text-slate-700">
          Importando <b class="text-sky-800">{{ excelImportProcesados }}</b>/<b>{{ excelImportTotal }}</b>
        </span>
      </div>
    </div>
  </div>
</div>


<app-egresados-dashboard
  *ngIf="!isEgresado"
  [isEgresado]="isEgresado"
  [egresados]="egresados"
  [loading]="loading"
  [stats]="stats"
  [donutOptions]="donutOptions"
  [donutSituacionData]="donutSituacionData"
  [donutDocsData]="donutDocsData"
  [donutAnioData]="donutAnioData"
  [cohortesOptions]="cohortesOptions"
  [cohorteSeleccionada]="cohorteSeleccionada"
  [kpiCohorte]="kpiCohorte"
  [chartOptionsCohorte]="chartOptionsCohorte"
  [barSituacionCohorteData]="barSituacionCohorteData"
  [donutRentasCohorteData]="donutRentasCohorteData"
  [filtrosConfig]="filtrosConfig"
  [filtroValores]="filtroValores"
  (filtroValoresChange)="filtroValores = $event"
  [modalFiltrosVisible]="modalFiltrosVisible"
  (modalFiltrosVisibleChange)="modalFiltrosVisible = $event"
  [modalDocsVisible]="modalDocsVisible"
  [documentosModal]="documentosModal"
  (cerrarModalDocumentos)="modalDocsVisible = false"
  [getDropdownOptions]="getDropdownOptions.bind(this)"
  (abrirFormularioNuevo)="abrirFormularioNuevo()"
  (abrirEdicion)="abrirEdicion($event)"
  (eliminar)="eliminar($event)"
  (abrirModalDocumentos)="abrirModalDocumentos($event)"
  (onCohorteChange)="onCohorteChange($event)"
  (verDocumento)="verDocumento($event)"
  (descargarDocumento)="descargarDocumento($event)"
  (eliminarDocumento)="eliminarDocumento($event)"
/>
