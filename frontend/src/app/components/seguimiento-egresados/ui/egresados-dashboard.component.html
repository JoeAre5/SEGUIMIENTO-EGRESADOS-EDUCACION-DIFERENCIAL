<!-- TABLA DE EGRESADOS -->
<div class="m-10 bg-white p-8 shadow-lg rounded-md" *ngIf="!isEgresado">
  <!-- Tarjetas resumen arriba de la tabla -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Total Egresados</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.total }}</p>
      <p class="text-xs text-white/80">registros</p>
    </div>

    <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Trabajando</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.trabajando }}</p>
      <p class="text-xs text-white/80">activos</p>
    </div>

    <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Cesante</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.cesante }}</p>
      <p class="text-xs text-white/80">sin trabajo</p>
    </div>

    <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">Otro</p>
      <p class="text-2xl font-extrabold text-white">{{ stats.otro }}</p>
      <p class="text-xs text-white/80">otros casos</p>
    </div>

    <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
      <p class="text-xs text-white/90 font-semibold">AÃ±o de cohorte a la que pertenece</p>
      <p class="text-2xl font-extrabold text-white">â€”</p>
      <p class="text-xs text-white/80">en tabla</p>
    </div>
  </div>

  <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
    <div class="flex items-center gap-3">
      <h2 class="text-xl font-bold text-sky-700">Listado de Egresados</h2>

      <button
        pButton
        type="button"
        icon="pi pi-plus"
        label="Nuevo / Editar"
        class="p-button-sm p-button-info"
        (click)="abrirFormularioNuevo.emit()"
      ></button>

      <button
        pButton
        type="button"
        icon="pi pi-filter"
        label="Filtros"
        class="p-button-sm p-button-outlined p-button-secondary"
        (click)="setModalFiltrosVisible(true)"
      ></button>

      <button
        pButton
        type="button"
        icon="pi pi-filter-slash"
        label="Limpiar filtros"
        class="p-button-sm p-button-outlined p-button-secondary"
        (click)="clearFilters()"
      ></button>
    </div>

    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input pInputText type="text" placeholder="Buscar..." (input)="onGlobalFilter($event)" />
    </span>
  </div>


  <div class="overflow-x-auto rounded-xl border border-gray-200 p-fluid h-[720px]">
    <p-table
      #dt
      [value]="egresados"
      [paginator]="true"
      [rows]="6"
      [rowsPerPageOptions]="[6, 10, 20, 50]"
      [loading]="loading"
      [rowHover]="true"
      [scrollable]="true"
      scrollHeight="flex"
      [tableStyle]="{ 'min-width': '1700px' }"
      class="p-datatable-sm p-datatable-gridlines egresados-table"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
      [globalFilterFields]="[
        'Estudiante.nombreCompleto',
        'Estudiante.rut',
        'situacionActual',
        'situacionActualOtro',
        'empresa',
        'cargo',
        'nivelRentas',
        'anioFinEstudios',
        'telefono',
        'emailContacto'
      ]"
    >
      <ng-template pTemplate="header">
        <tr>
          <th class="col-nombre">Nombre</th>
          <th>RUT</th>
          <th>SituaciÃ³n</th>
          <th>InstituciÃ³n o establecimiento</th>
          <th>Cargo</th>
          <th class="col-rentas">Nivel de rentas</th>
          <th>AÃ±o de cohorte a la que pertenece</th>
          <th>TelÃ©fono de contacto</th>
          <th>Correo</th>
          <th style="width: 120px;">Documentos</th>
          <th class="col-acciones" style="width: 140px;">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row>
        <tr>

          <td class="col-nombre">
            <span
              class="font-semibold text-slate-900"
              [pTooltip]="row?.Estudiante?.nombreCompleto || 'â€”'"
              tooltipPosition="top"
            >
              {{ row?.Estudiante?.nombreCompleto || 'â€”' }}
            </span>
          </td>

          <td>
            <span class="text-slate-800">
              {{ row?.Estudiante?.rut || 'â€”' }}
            </span>
          </td>


          <td>
            <p-tag
              [value]="row?.situacionActual || 'â€”'"
              [rounded]="true"
              styleClass="bg-white text-sky-800 border border-sky-700 text-sm px-3 py-2 font-bold"
            ></p-tag>

            <div
              class="text-xs text-gray-500 mt-1"
              *ngIf="row?.situacionActual === 'Otro' && row?.situacionActualOtro"
            >
              {{ row?.situacionActualOtro }}
            </div>
          </td>


          <td>
            <span
              class="text-slate-800"
              *ngIf="row?.empresa; else sinEmpresa"
              [pTooltip]="row?.empresa"
              tooltipPosition="top"
            >
              {{ row?.empresa }}
            </span>
            <ng-template #sinEmpresa>â€”</ng-template>
          </td>


          <td>
            <span
              class="text-slate-800"
              *ngIf="row?.cargo; else sinCargo"
              [pTooltip]="row?.cargo"
              tooltipPosition="top"
            >
              {{ row?.cargo }}
            </span>
            <ng-template #sinCargo>â€”</ng-template>
          </td>


          <td class="col-rentas">
            <span
              class="text-slate-800"
              *ngIf="row?.nivelRentas; else sinRenta"
              [pTooltip]="row?.nivelRentas"
              tooltipPosition="top"
            >
              {{ row?.nivelRentas }}
            </span>
            <ng-template #sinRenta>â€”</ng-template>
          </td>


          <td class="col-cohorte">
            <p-tag
              *ngIf="row?.anioFinEstudios; else sinAnioFin"
              [value]="row?.anioFinEstudios"
              [rounded]="true"
              styleClass="bg-white text-sky-800 border border-sky-700 text-sm px-3 py-2 font-bold"
            ></p-tag>
            <ng-template #sinAnioFin>â€”</ng-template>
          </td>


          <td>
            <span class="text-slate-800">
              {{ row?.telefono || 'â€”' }}
            </span>
          </td>


          <td>
            <span
              class="text-slate-800"
              *ngIf="row?.emailContacto; else sinMail"
              [pTooltip]="row?.emailContacto"
              tooltipPosition="top"
            >
              {{ row?.emailContacto }}
            </span>
            <ng-template #sinMail>â€”</ng-template>
          </td>

          <td class="text-center">
            <button
              pButton
              icon="pi pi-file"
              class="p-button-rounded p-button-sm p-button-secondary"
              pTooltip="Documentos"
              (click)="abrirModalDocumentos.emit(row)"
            ></button>
          </td>

          <td class="col-acciones">
            <div class="acciones-wrap">
              <button
                pButton
                icon="pi pi-pencil"
                class="p-button-rounded p-button-sm p-button-info"
                pTooltip="Editar"
                (click)="abrirEdicion.emit(row)"
              ></button>

              <button
                pButton
                icon="pi pi-trash"
                class="p-button-rounded p-button-sm p-button-danger"
                pTooltip="Eliminar"
                (click)="eliminar.emit(row)"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="11" class="text-center text-gray-500 py-6">No hay registros para mostrar.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>


  <div class="mt-10" [@fadeSlide]="dashboardAnimKey">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div>
        <h3 class="text-lg font-bold text-sky-700">ðŸ“ˆ Dashboard por cohorte</h3>
        <p class="text-xs text-gray-500">
          Cohorte = AÃ±o de cohorte a la que pertenece. Selecciona una cohorte para ver mÃ©tricas.
        </p>
      </div>

      <div class="w-full sm:w-[320px]">
        <p-dropdown
          [options]="cohortesOptions"
          optionLabel="label"
          optionValue="value"
          [ngModel]="cohorteSeleccionada"
          [ngModelOptions]="{ standalone: true }"
          (ngModelChange)="onCohorteDropdownChange($event)"
          placeholder="Selecciona cohorte"
          [showClear]="true"
          class="w-full"
        ></p-dropdown>
      </div>
    </div>


    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6" [@kpiPop]="kpiAnimKey">
      <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
        <p class="text-xs text-white/90 font-semibold">Total cohorte</p>
        <p class="text-2xl font-extrabold text-white">{{ kpiCohorte.total }}</p>
        <p class="text-xs text-white/80">registros</p>
      </div>

      <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
        <p class="text-xs text-white/90 font-semibold">Trabajando</p>
        <p class="text-2xl font-extrabold text-white">{{ kpiCohorte.trabajando }}</p>
        <p class="text-xs text-white/80">activos</p>
      </div>

      <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
        <p class="text-xs text-white/90 font-semibold">Cesante</p>
        <p class="text-2xl font-extrabold text-white">{{ kpiCohorte.cesante }}</p>
        <p class="text-xs text-white/80">sin trabajo</p>
      </div>

      <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
        <p class="text-xs text-white/90 font-semibold">Otro</p>
        <p class="text-2xl font-extrabold text-white">{{ kpiCohorte.otro }}</p>
        <p class="text-xs text-white/80">otros casos</p>
      </div>

      <div class="rounded-xl border border-sky-700 bg-sky-700 p-4 shadow-sm">
        <p class="text-xs text-white/90 font-semibold">% con documentos</p>
        <p class="text-2xl font-extrabold text-white">{{ kpiCohorte.porcentajeConDocs }}%</p>
        <p class="text-xs text-white/80">({{ kpiCohorte.conDocs }}/{{ kpiCohorte.total }})</p>
      </div>
    </div>

    <!-- GrÃ¡ficos cohorte -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-5" [@chartFade]="chartsAnimKey">
        <div class="flex items-center justify-between mb-3">
          <p class="font-semibold text-gray-700">SituaciÃ³n (cohorte)</p>
          <span class="text-xs text-gray-500">Barra</span>
        </div>
        <div class="h-[300px]">
          <ng-container *ngIf="chartsVisible">
            <p-chart type="bar" [data]="barSituacionCohorteData" [options]="chartOptionsCohorte"></p-chart>
          </ng-container>
        </div>
      </div>

      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-5" [@chartFade]="chartsAnimKey">
        <div class="flex items-center justify-between mb-3">
          <p class="font-semibold text-gray-700">Nivel de rentas (cohorte)</p>
          <span class="text-xs text-gray-500">Donut</span>
        </div>
        <div class="h-[300px]">
          <ng-container *ngIf="chartsVisible">
            <p-chart type="doughnut" [data]="donutRentasCohorteData" [options]="donutOptions"></p-chart>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="text-xs text-gray-500 mt-3" *ngIf="!cohorteSeleccionada">
      ðŸ“Œ Selecciona una cohorte para visualizar el dashboard.
    </div>
  </div>

  <!-- ESTADÃSTICAS (DONUTS) -->
  <div class="mt-8">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold text-sky-700">ðŸ“Š EstadÃ­sticas</h3>
      <span class="text-xs text-gray-500">Basado en todos los registros</span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="font-semibold text-gray-700">DistribuciÃ³n por situaciÃ³n</p>
          <span class="text-xs text-gray-500">Global</span>
        </div>
        <div class="h-[260px]">
          <p-chart type="doughnut" [data]="donutSituacionData" [options]="donutOptions"></p-chart>
        </div>
      </div>

      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="font-semibold text-gray-700">Egresados con documentos</p>
          <span class="text-xs text-gray-500">Con / Sin</span>
        </div>
        <div class="h-[260px]">
          <p-chart type="doughnut" [data]="donutDocsData" [options]="donutOptions"></p-chart>
        </div>
      </div>

      <div class="rounded-2xl border border-gray-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
          <p class="font-semibold text-gray-700">% por cohorte</p>
          <span class="text-xs text-gray-500">Top aÃ±os</span>
        </div>
        <div class="h-[260px]">
          <p-chart type="doughnut" [data]="donutAnioData" [options]="donutOptions"></p-chart>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL FILTROS -->
<p-dialog
  *ngIf="!isEgresado"
  [(visible)]="modalFiltrosVisible"
  (visibleChange)="modalFiltrosVisibleChange.emit($event)"
  [modal]="true"
  [style]="{ width: '720px' }"
  header="ðŸ”Ž Filtros"
>
  <div class="grid grid-cols-2 gap-4">
    <ng-container *ngFor="let f of filtrosConfig">
      <div class="col-span-2" *ngIf="f.type === 'dropdown'">
        <label class="block font-semibold mb-2">{{ f.label }}</label>

        <p-dropdown
          [options]="getDropdownOptions(f.dropdownKey)"
          optionLabel="label"
          optionValue="value"
          [showClear]="true"
          placeholder="Todas"
          class="w-full"
          (onChange)="dt.filter($event.value, f.field, 'equals')"
        ></p-dropdown>
      </div>

      <div class="col-span-2" *ngIf="f.type === 'text'">
        <label class="block font-semibold mb-2">{{ f.label }}</label>
        <input
          pInputText
          class="w-full"
          [placeholder]="f.placeholder || 'Filtrar...'"
          (input)="dt.filter($any($event.target).value, f.field, 'contains')"
        />
      </div>

      <div class="col-span-2" *ngIf="f.type === 'range-number'">
        <label class="block font-semibold mb-2">{{ f.label }}</label>

        <div class="grid grid-cols-2 gap-3">
          <p-inputNumber
            class="w-full"
            [useGrouping]="false"
            placeholder="Desde"
            [ngModel]="filtroValores[f.field]?.min ?? null"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onRangoFiltroChange(f.field, 'min', $event)"
          ></p-inputNumber>

          <p-inputNumber
            class="w-full"
            [useGrouping]="false"
            placeholder="Hasta"
            [ngModel]="filtroValores[f.field]?.max ?? null"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onRangoFiltroChange(f.field, 'max', $event)"
          ></p-inputNumber>
        </div>
      </div>
    </ng-container>
  </div>

  <div class="flex justify-end gap-2 mt-6">
    <button
      pButton
      type="button"
      icon="pi pi-filter-slash"
      label="Limpiar"
      class="p-button-sm p-button-outlined p-button-secondary"
      (click)="clearFilters(); filtroValoresChange.emit({}); setModalFiltrosVisible(false)"
    ></button>

    <button
      pButton
      type="button"
      icon="pi pi-check"
      label="Listo"
      class="p-button-sm p-button-info"
      (click)="setModalFiltrosVisible(false)"
    ></button>
  </div>
</p-dialog>

<!-- MODAL DOCUMENTOS -->
<p-dialog
  [(visible)]="modalDocsVisible"
  [modal]="true"
  [style]="{ width: '650px' }"
  header="ðŸ“Ž Documentos del Egresado"
  (onHide)="closeDocsModal()"
>
  <div *ngIf="documentosModal.length === 0" class="text-gray-500 italic">
    No hay documentos disponibles.
  </div>

  <div *ngIf="documentosModal.length > 0" class="mt-3">
    <p-table [value]="documentosModal" class="p-datatable-sm">
      <ng-template pTemplate="header">
        <tr>
          <th>Nombre</th>
          <th style="width: 180px;">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-doc>
        <tr>
          <td>{{ doc.nombre }}</td>
          <td class="flex gap-2">
            <button
              pButton
              icon="pi pi-eye"
              class="p-button-rounded p-button-sm p-button-secondary"
              pTooltip="Ver"
              (click)="verDocumento.emit(doc)"
            ></button>

            <button
              pButton
              icon="pi pi-download"
              class="p-button-rounded p-button-sm p-button-info"
              pTooltip="Descargar"
              (click)="descargarDocumento.emit(doc)"
            ></button>

            <button
              pButton
              icon="pi pi-trash"
              class="p-button-rounded p-button-sm p-button-danger"
              pTooltip="Eliminar"
              *ngIf="!isEgresado"
              (click)="eliminarDocumento.emit(doc)"
            ></button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-dialog>
